name: 网站爬取器
on:
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 配置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 安装谷歌 Chrome 浏览器（核心！直接装官方版）
        run: |
          # 添加Chrome源
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          # 更新并安装Chrome
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable ffmpeg
          # 验证Chrome安装
          google-chrome --version

      - name: 安装项目依赖（仅装Playwright Core，不下载浏览器）
        run: npm install playwright-core fs-extra --registry=https://registry.npmmirror.com

      - name: 执行爬取脚本（用已安装的Chrome）
        run: node src/crawler.js

      - name: 上传爬取结果
        uses: actions/upload-artifact@v4
        with:
          name: 爬取结果-${{ github.run_id }}
          path: crawl-results/
          retention-days: 30
          if-no-files-found: warn